#!/scratch/bin/ruby

$0 = "messier"
$LOAD_PATH.unshift "#{ENV["PROJECT_X_BASE"]}/lib/"

TABLE_FILEPATH = "#{ENV['HOME']}/src/project-x/mozart/project-x-musicdb.tct"
require "socket"
require "spandex/application"
require "spandex/card"
require "spandex/list"
require "messier/artist"

class ListCard < Spandex::Card
  jog_wheel_left method: -> { @list.select_previous; show }
  jog_wheel_right method: -> { @list.select_next; show }
  jog_wheel_button card: -> { @list.selected }
end

class Menu < ListCard
  top_left :back

  ITEMS = %w( Artists Genres Playlists )

  def show
    @list ||= Spandex::List.new ITEMS
    render "<button position=top_left>Back</button><title>Mark's music</title>#{@list}"
  end
end

class Genres < ListCard
  top_left :back
  jog_wheel_button :card => 'artists', params: -> { @list.selected }

  def show
    @list ||= Spandex::List.new Messier::Genre.all
    render "<button position=top_left>Back</button><title>Genres</title>#{@list}"
  end
end

class Artists < ListCard
  top_left :back
  jog_wheel_button :card => 'albums', params: -> { @list.selected }

  def show
    if @params
      @list ||= Spandex::List.new @params.artists
      @params = nil
    else
      @list ||= Spandex::List.new Messier::Artist.all
    end
    render "<button position=top_left>Back</button><title>Artists</title>#{@list}"
  end
end

class Albums < ListCard
  top_left :back
  jog_wheel_button :card => 'tracks', params: -> { @list.selected }

  def show
    @list ||= Spandex::List.new @params.albums
    render "<button position=top_left>Back</button><title>Albums</title>#{@list}"
  end
end

class Tracks < ListCard
  top_left :back
  jog_wheel_button :method => :play

  def play
    ids = @list.selected_to_end.map(&:id)
    pass_focus(application: "mozart", method: "play_ids", params: ids.join(", "))
  end

  def show
    @list ||= Spandex::List.new @params.tracks
    render "<button position=top_left>Back</button><title>Tracks</title>#{@list}"
  end
end

class Playlists < Spandex::Card
  top_left :back

  def show
    render "<button position=top_left>Back</button><title>Playlists</title><text x=20 y=30>No playlists defined</text>"
  end
end

class Messier::Messier < Spandex::Application
  entry_point :menu
end

Messier::Messier.new.run
